<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HBL 골프 클럽 | 선수 프로필</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #04090f;
      --panel: rgba(16, 31, 42, 0.9);
      --border: rgba(255, 255, 255, 0.08);
      --text: #e9f1f6;
      --muted: #9fb3c2;
      --accent: #4ce2b1;
      --accent-2: #6cb7ff;
      --radius: 18px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      min-height: 100vh;
      background:
        radial-gradient(circle at 10% 20%, rgba(76, 226, 177, 0.12), transparent 25%),
        radial-gradient(circle at 80% 0%, rgba(108, 183, 255, 0.12), transparent 28%),
        linear-gradient(160deg, #03060c 0%, #06121a 40%, #081d21 75%, #04090f 100%);
      color: var(--text);
      font-family: 'Manrope', 'Noto Sans KR', system-ui, -apple-system, sans-serif;
      padding: 0 18px 40px;
    }
    a { color: inherit; text-decoration: none; }
    header {
      position: sticky; top: 0; z-index: 100;
      background: linear-gradient(180deg, rgba(4, 9, 15, 0.9), rgba(4, 9, 15, 0.6));
      backdrop-filter: blur(14px);
      border-bottom: 1px solid var(--border);
    }
    .topbar { max-width: 1100px; margin: 0 auto; padding: 16px 0; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .brand { display: inline-flex; align-items: center; gap: 12px; }
    .brand-mark { width: 44px; height: 44px; border-radius: 12px; background: linear-gradient(135deg, #23b47e, #0f5f4f); display: grid; place-items: center; font-weight: 800; letter-spacing: -0.02em; color: #fff; }
    .brand-text { display: flex; flex-direction: column; gap: 2px; }
    .brand-text strong { font-size: 18px; letter-spacing: -0.02em; }
    .brand-text span { color: var(--muted); font-size: 12px; }
    nav { display: flex; align-items: center; gap: 18px; }
    nav a { padding: 10px 12px; border-radius: 12px; color: var(--muted); font-weight: 600; transition: background 0.2s ease, color 0.2s ease; }
    nav a.active, nav a:hover { background: rgba(255, 255, 255, 0.06); color: var(--text); }
    .nav-toggle { display: none; width: 38px; height: 38px; border-radius: 10px; border: 1px solid var(--border); background: rgba(255, 255, 255, 0.04); color: var(--text); align-items: center; justify-content: center; cursor: pointer; }
    .ghost-btn { padding: 10px 14px; border-radius: 12px; border: 1px solid var(--border); color: var(--text); background: transparent; cursor: pointer; font-weight: 700; }
    main { max-width: 1100px; margin: 22px auto 0; display: flex; flex-direction: column; gap: 16px; }
    .hero { border-radius: 24px; padding: clamp(18px, 3vw, 26px); background: linear-gradient(135deg, rgba(108, 183, 255, 0.12), rgba(8, 29, 33, 0.85)); border: 1px solid var(--border); box-shadow: 0 20px 60px rgba(0,0,0,0.32); display: grid; grid-template-columns: auto 1fr; gap: 16px; align-items: center; }
    .avatar-lg { width: 120px; height: 120px; border-radius: 28px; object-fit: cover; border: 3px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); }
    .hero h1 { font-size: clamp(26px, 4vw, 34px); letter-spacing: -0.04em; }
    .hero .muted { color: var(--muted); margin-top: 4px; }
    .chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .chip { padding: 8px 10px; border-radius: 12px; background: rgba(255,255,255,0.08); font-weight: 700; color: var(--text); font-size: 13px; }
    .grid { display: grid; gap: 14px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
    .panel { padding: 16px; border-radius: var(--radius); background: var(--panel); border: 1px solid var(--border); box-shadow: 0 16px 50px rgba(0,0,0,0.28); }
    .panel-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .panel-title { font-weight: 800; letter-spacing: -0.02em; }
    .muted { color: var(--muted); font-size: 13px; }
    .stat-card { padding: 12px; border-radius: 14px; background: rgba(255,255,255,0.04); border: 1px solid var(--border); }
    .stat-card .label { color: var(--muted); font-size: 12px; }
    .stat-card .value { font-size: 22px; font-weight: 800; margin-top: 4px; }
    .info-list { display: grid; gap: 8px; }
    .info-row { display: flex; justify-content: space-between; border: 1px solid var(--border); padding: 10px 12px; border-radius: 12px; background: rgba(255,255,255,0.03); }
    .round-card { border: 1px solid var(--border); border-radius: 14px; padding: 12px; background: rgba(255,255,255,0.03); margin-bottom: 10px; }
    .round-header { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .badge { padding: 6px 10px; border-radius: 10px; background: rgba(255,255,255,0.08); font-size: 12px; letter-spacing: 0.02em; }
    .score-line { display: flex; gap: 10px; flex-wrap: wrap; color: var(--muted); font-size: 13px; margin-top: 8px; }
    .hole-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 6px; margin-top: 10px; }
    .hole-chip { border: 1px solid var(--border); border-radius: 10px; padding: 8px 6px; background: rgba(255, 255, 255, 0.04); font-size: 12px; }
    .toggle { cursor: pointer; color: var(--muted); font-size: 12px; }
    .loading { padding: 20px; text-align: center; color: var(--muted); }
    @media (max-width: 840px) { .hero { grid-template-columns: 1fr; } nav { position: fixed; top:70px; left:0; right:0; padding:14px; background: rgba(4,9,15,0.95); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); transform: translateY(-120%); transition: transform 0.2s ease; flex-wrap: wrap; gap:10px; justify-content:center;} nav.open { transform: translateY(0);} .nav-toggle { display: inline-flex;} }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div class="brand">
        <div class="brand-mark">HBL</div>
        <div class="brand-text"><strong>HBL Golf Club</strong><span>Player profile</span></div>
      </div>
      <nav id="navMenu">
        <a href="main.html">대시보드</a>
        <a href="schedule.html">일정</a>
        <a href="tournament-records.html">기록</a>
        <a href="players.html">선수</a>
      </nav>
      <div style="display:flex; align-items:center; gap:10px;">
        <button class="ghost-btn" id="logoutBtn" type="button">로그아웃</button>
        <button class="nav-toggle" id="navToggle" aria-label="메뉴 열기">☰</button>
      </div>
    </div>
  </header>

  <main id="main-content">
    <div class="loading">선수 정보를 불러오는 중...</div>
  </main>

  <script>
    const API_BASE_URL = 'https://port-0-hblgolfbakend-mb4ipg5fd735a020.sel4.cloudtype.app';
    const navMenu = document.getElementById('navMenu');
    const navToggle = document.getElementById('navToggle');
    const logoutBtn = document.getElementById('logoutBtn');
    let currentPlayer = null;
    let playerRecords = [];

    document.addEventListener('DOMContentLoaded', () => {
      setupNav();
      const playerId = getPlayerIdFromUrl();
      loadPlayerProfile(playerId);
    });

    function setupNav() {
      navToggle?.addEventListener('click', () => navMenu.classList.toggle('open'));
      navMenu.querySelectorAll('a').forEach(link => link.addEventListener('click', () => navMenu.classList.remove('open')));
      logoutBtn?.addEventListener('click', () => {
        sessionStorage.removeItem('hbl_authenticated');
        sessionStorage.removeItem('hbl_auth_time');
        window.location.href = 'index.html';
      });
    }

    function getPlayerIdFromUrl() {
      const filename = window.location.pathname.split('/').pop();
      const map = {
        'player-profile-page-jay.html': 1,
        'player-profile-page.html': 1,
        'player-profile-page-suk.html': 2,
        'player-profile-page-sang.html': 3,
        'player-profile-page-bok.html': 4
      };
      return map[filename] || 1;
    }

    async function loadPlayerProfile(playerId) {
      try {
        const res = await fetch(`${API_BASE_URL}/api/players/${playerId}`);
        if (!res.ok) throw new Error('player api fail');
        currentPlayer = await res.json();
      } catch (err) {
        console.warn('Player API 실패, fallback 사용:', err);
        currentPlayer = getFallbackPlayers().find(p => p.id === playerId) || getFallbackPlayers()[0];
      }
      await loadPlayerRecords(playerId);
      renderProfile();
    }

    async function loadPlayerRecords(playerId) {
      try {
        const roundsRes = await fetch(`${API_BASE_URL}/api/rounds`);
        const rounds = await roundsRes.json();
        const records = [];
        for (const round of rounds) {
          try {
            const scoresRes = await fetch(`${API_BASE_URL}/api/rounds/${round.id}/scores`);
            const scores = await scoresRes.json();
            const playerScore = scores.find(s => String(s.player_id) === String(playerId));
            if (playerScore) {
              records.push({ ...playerScore, round_name: round.round_name, round_date: round.round_date, course_name: round.course_name || '미정' });
            }
          } catch (err) { console.warn('scores load fail', err); }
        }
        playerRecords = records.sort((a,b) => new Date(b.round_date) - new Date(a.round_date));
      } catch (err) {
        console.warn('round load fail', err);
        playerRecords = getFallbackRecords();
      }
    }

    function renderProfile() {
      const main = document.getElementById('main-content');
      if (!currentPlayer) {
        main.innerHTML = '<div class="loading">선수 정보를 불러오지 못했습니다.</div>';
        return;
      }
      const stats = computeStats(playerRecords);
      const chips = [
        `국적 ${currentPlayer.nationality || 'KR'}`,
        `입회 ${currentPlayer.join_year || '-'}년`,
        currentPlayer.membership_type || 'HBL'
      ];

      const roundsHtml = playerRecords.length ? playerRecords.map((rec, idx) => {
        const holeHtml = rec.hole_scores && rec.hole_scores.length ? rec.hole_scores.map((h, i) => `<div class="hole-chip">${i+1}H · ${h || '-'}</div>`).join('') : '<div class="muted">홀별 스코어 없음</div>';
        return `
          <div class="round-card">
            <div class="round-header">
              <div>
                <div class="panel-title">${rec.round_name || '라운드'}</div>
                <div class="muted">${formatDate(rec.round_date)} · ${rec.course_name}</div>
              </div>
              <div class="badge">${rec.ranking ? `순위 ${rec.ranking}` : '참가'}</div>
            </div>
            <div class="score-line">
              <span>총타 ${rec.total_score ?? '-'}타</span>
              <span>버디 ${rec.birdie_count ?? 0}</span>
              <span>니어리스트 ${rec.nearest_count ?? 0}</span>
            </div>
            <div class="toggle" onclick="toggleHole('${idx}')">홀별 스코어 보기</div>
            <div class="hole-grid" id="holes-${idx}" style="display:none;">${holeHtml}</div>
          </div>`;
      }).join('') : '<div class="muted">라운드 기록이 없습니다.</div>';

      main.innerHTML = `
        <section class="hero">
          <img class="avatar-lg" src="${currentPlayer.photo_url || 'images/jay.png'}" alt="${currentPlayer.name}">
          <div>
            <h1>${currentPlayer.name}</h1>
            <div class="muted">${currentPlayer.eng_name || ''}</div>
            <div class="chips">${chips.map(c => `<span class="chip">${c}</span>`).join('')}</div>
          </div>
        </section>

        <section class="grid">
          <article class="panel">
            <div class="panel-head"><div class="panel-title">스탯</div></div>
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(140px,1fr));">
              <div class="stat-card"><div class="label">평균 타수</div><div class="value">${stats.avg}</div></div>
              <div class="stat-card"><div class="label">베스트</div><div class="value">${stats.best}</div></div>
              <div class="stat-card"><div class="label">승수</div><div class="value">${stats.wins}</div></div>
              <div class="stat-card"><div class="label">라운드</div><div class="value">${stats.played}</div></div>
            </div>
          </article>

          <article class="panel">
            <div class="panel-head"><div class="panel-title">프로필</div></div>
            <div class="info-list">
              <div class="info-row"><span>생년월일</span><span>${formatBirthDate(currentPlayer.birth_date)}</span></div>
              <div class="info-row"><span>키/몸무게</span><span>${currentPlayer.height || 'N/A'}cm / ${currentPlayer.weight || 'N/A'}kg</span></div>
              <div class="info-row"><span>스폰서</span><span>${currentPlayer.sponsor || '미정'}</span></div>
              <div class="info-row"><span>메모</span><span>${currentPlayer.political_view || '메모 없음'}</span></div>
            </div>
          </article>
        </section>

        <section class="panel">
          <div class="panel-head"><div class="panel-title">라운드 기록</div></div>
          ${roundsHtml}
        </section>
      `;
    }

    function toggleHole(idx) {
      const el = document.getElementById(`holes-${idx}`);
      if (!el) return;
      el.style.display = el.style.display === 'none' ? 'grid' : 'none';
    }

    function computeStats(records) {
      if (!records.length) return { avg: 'N/A', best: 'N/A', wins: 0, played: 0 };
      const totalSum = records.reduce((s, r) => s + (r.total_score || 0), 0);
      const avg = Math.round((totalSum / records.length) * 10) / 10;
      const best = Math.min(...records.map(r => r.total_score || Infinity));
      const wins = records.filter(r => r.ranking === 1).length;
      return { avg, best: best === Infinity ? 'N/A' : best, wins, played: records.length };
    }

    function formatDate(dateString) {
      if (!dateString) return '-';
      const d = new Date(dateString);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      const w = ['일','월','화','수','목','금','토'][d.getDay()];
      return `${y}.${m}.${day} (${w})`;
    }
    function formatBirthDate(date) { return date ? formatDate(date) : '미정'; }

    function getFallbackPlayers() {
      return [
        { id: 1, name: '김종혁', eng_name: 'Jay Kim', nationality: 'KR', photo_url: 'images/jay.png', membership_type: '정회원', join_year: 2022, height: 175, weight: 73 },
        { id: 2, name: '정인석', eng_name: 'Inseok Jeong', nationality: 'KR', photo_url: 'images/suk.PNG', membership_type: '정회원', join_year: 2022, height: 178, weight: 75 },
        { id: 3, name: '김상현', eng_name: 'Sang Kim', nationality: 'CN', photo_url: 'images/sang.jpg', membership_type: '정회원', join_year: 2010, height: 180, weight: 78 },
        { id: 4, name: '조영복', eng_name: 'Youngbok Cho', nationality: 'KR', photo_url: 'images/bok2.jpg', membership_type: '정회원', join_year: 2024, height: 176, weight: 74 }
      ];
    }

    function getFallbackRecords() {
      return [
        { round_name: '6월 정기 라운드', round_date: '2025-06-06', course_name: '스톤게이트 CC', total_score: 99, ranking: 1, birdie_count: 3, nearest_count: 1, hole_scores: [5,4,4,4,3,5,4,5,4,4,3,5,4,4,5,4,3,4] },
        { round_name: '5월 정기 라운드', round_date: '2025-05-11', course_name: '발리오스 CC', total_score: 105, ranking: 2, birdie_count: 2, nearest_count: 0, hole_scores: [5,5,4,5,3,6,4,5,5,5,4,5,5,4,6,4,3,5] }
      ];
    }
  </script>
</body>
</html>
