<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HBL 골프 클럽 | 라운드 기록</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #04090f;
            --panel: rgba(16, 31, 42, 0.9);
            --border: rgba(255, 255, 255, 0.08);
            --text: #e9f1f6;
            --muted: #9fb3c2;
            --accent: #4ce2b1;
            --accent-2: #6cb7ff;
            --radius: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            min-height: 100vh;
            background:
                radial-gradient(circle at 10% 20%, rgba(76, 226, 177, 0.12), transparent 25%),
                radial-gradient(circle at 80% 0%, rgba(108, 183, 255, 0.12), transparent 28%),
                linear-gradient(160deg, #03060c 0%, #06121a 40%, #081d21 75%, #04090f 100%);
            color: var(--text);
            font-family: 'Manrope', 'Noto Sans KR', system-ui, -apple-system, sans-serif;
            padding: 0 20px 40px;
        }

        a { color: inherit; text-decoration: none; }

        header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: linear-gradient(180deg, rgba(4, 9, 15, 0.9), rgba(4, 9, 15, 0.6));
            backdrop-filter: blur(14px);
            border-bottom: 1px solid var(--border);
        }

        .topbar {
            max-width: 1100px;
            margin: 0 auto;
            padding: 16px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .brand {
            display: inline-flex;
            align-items: center;
            gap: 12px;
        }

        .brand-mark {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: linear-gradient(135deg, #23b47e, #0f5f4f);
            display: grid;
            place-items: center;
            font-weight: 800;
            letter-spacing: -0.02em;
            color: #fff;
        }

        .brand-text { display: flex; flex-direction: column; gap: 2px; }
        .brand-text strong { font-size: 18px; letter-spacing: -0.02em; }
        .brand-text span { color: var(--muted); font-size: 12px; }

        nav { display: flex; align-items: center; gap: 18px; }
        nav a {
            padding: 10px 12px;
            border-radius: 12px;
            color: var(--muted);
            font-weight: 600;
            transition: background 0.2s ease, color 0.2s ease;
        }
        nav a.active,
        nav a:hover { background: rgba(255, 255, 255, 0.06); color: var(--text); }

        .ghost-btn {
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid var(--border);
            color: var(--text);
            background: transparent;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.2s ease;
        }
        .ghost-btn:hover { border-color: rgba(255, 255, 255, 0.2); transform: translateY(-1px); }

        .nav-toggle {
            display: none;
            width: 38px;
            height: 38px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.04);
            color: var(--text);
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        main {
            max-width: 1100px;
            margin: 24px auto 0;
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .hero {
            border-radius: 22px;
            padding: clamp(18px, 3vw, 26px);
            background: linear-gradient(135deg, rgba(76, 226, 177, 0.12), rgba(8, 29, 33, 0.85));
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.32);
        }
        .hero h1 { font-size: clamp(26px, 4vw, 34px); letter-spacing: -0.04em; margin-bottom: 8px; }
        .hero p { color: var(--muted); line-height: 1.5; }

        .filters { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px; }
        .pill-input {
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.04);
            color: var(--text);
        }

        .panel {
            padding: 16px;
            border-radius: var(--radius);
            background: var(--panel);
            border: 1px solid var(--border);
            box-shadow: 0 16px 50px rgba(0, 0, 0, 0.28);
        }

        .panel-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .panel-title { font-weight: 800; letter-spacing: -0.02em; }
        .muted { color: var(--muted); font-size: 13px; }

        .round-list { display: flex; flex-wrap: wrap; gap: 10px; }
        .round-btn {
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.04);
            color: var(--text);
            cursor: pointer;
        }
        .round-btn.active { background: rgba(255, 255, 255, 0.1); }

        .round-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .stat-card {
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.04);
        }
        .stat-card .label { color: var(--muted); font-size: 13px; }
        .stat-card .value { font-weight: 800; font-size: 18px; margin-top: 4px; }

        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; color: var(--text); }
        th, td { padding: 12px 10px; text-align: center; }
        th { background: rgba(255, 255, 255, 0.05); }
        tr { border-bottom: 1px solid var(--border); }
        tr.clickable { cursor: pointer; }

        .details-row { background: rgba(255, 255, 255, 0.02); }
        .details-cell { padding: 0 0 12px 0; }
        .hole-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
            gap: 6px;
            padding: 10px 12px 2px;
        }
        .hole-chip {
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 8px 6px;
            background: rgba(255, 255, 255, 0.04);
            font-size: 12px;
        }
        .row-toggle { color: var(--muted); font-size: 12px; }

        .rank-badge {
            padding: 6px 10px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.06);
            font-weight: 700;
        }
        .row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            object-fit: cover;
            background: rgba(255, 255, 255, 0.1);
        }

        .status { padding: 12px; border: 1px dashed var(--border); border-radius: 12px; text-align: center; color: var(--muted); }

        @media (max-width: 920px) {
            nav {
                position: fixed;
                top: 70px;
                left: 0;
                right: 0;
                padding: 14px;
                background: rgba(4, 9, 15, 0.95);
                backdrop-filter: blur(10px);
                border-bottom: 1px solid var(--border);
                transform: translateY(-120%);
                transition: transform 0.2s ease;
                flex-wrap: wrap;
                gap: 10px;
                justify-content: center;
            }
            nav.open { transform: translateY(0); }
            .nav-toggle { display: inline-flex; }
        }
    </style>
</head>
<body>
    <header>
        <div class="topbar">
            <div class="brand">
                <div class="brand-mark">HBL</div>
                <div class="brand-text">
                    <strong>HBL Golf Club</strong>
                    <span>Round records</span>
                </div>
            </div>
            <nav id="navMenu">
                <a href="main.html">대시보드</a>
                <a href="schedule.html">일정</a>
                <a href="tournament-records.html" class="active">기록</a>
                <a href="players.html">선수</a>
            </nav>
            <div style="display:flex; align-items:center; gap:10px;">
                <button class="ghost-btn" id="logoutBtn" type="button">로그아웃</button>
                <button class="nav-toggle" id="navToggle" aria-label="메뉴 열기">☰</button>
            </div>
        </div>
    </header>

    <main>
        <section class="hero">
            <h1>라운드 기록</h1>
            <p>라운드별 우승자, 스코어, 평균 타수를 빠르게 조회하세요.</p>
            <div class="filters">
                <select class="pill-input" id="yearSelect">
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                </select>
                <input class="pill-input" id="searchInput" placeholder="코스명, 라운드명 검색" />
            </div>
        </section>

        <section class="panel">
            <div class="panel-head">
                <div>
                    <div class="panel-title">라운드 목록</div>
                    <div class="muted" id="roundCount">-</div>
                </div>
            </div>
            <div id="roundButtons" class="round-list"></div>
        </section>

        <section class="panel">
            <div class="panel-head">
                <div>
                    <div class="panel-title" id="roundTitle">라운드를 선택하세요</div>
                    <div class="muted" id="roundMeta">-</div>
                </div>
                <div class="muted" id="winnerMeta"></div>
            </div>
            <div class="round-summary" id="statsSummary">
                <div class="status">라운드를 선택하면 상세 정보가 표시됩니다.</div>
            </div>
        </section>

        <section class="panel">
            <div class="panel-head">
                <div class="panel-title">스코어보드</div>
                <div class="muted">Top 20</div>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>순위</th>
                            <th>선수</th>
                            <th>타수</th>
                            <th>버디</th>
                            <th>니어리스트</th>
                        </tr>
                    </thead>
                    <tbody id="recordsBody">
                        <tr><td colspan="5" class="status">라운드를 선택하세요.</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        const API_BASE_URL = 'https://port-0-hblgolfbakend-mb4ipg5fd735a020.sel4.cloudtype.app';
        const navMenu = document.getElementById('navMenu');
        const navToggle = document.getElementById('navToggle');
        const logoutBtn = document.getElementById('logoutBtn');
        const roundButtons = document.getElementById('roundButtons');
        const roundCount = document.getElementById('roundCount');
        const roundTitle = document.getElementById('roundTitle');
        const roundMeta = document.getElementById('roundMeta');
        const winnerMeta = document.getElementById('winnerMeta');
        const statsSummary = document.getElementById('statsSummary');
        const recordsBody = document.getElementById('recordsBody');
        const yearSelect = document.getElementById('yearSelect');
        const searchInput = document.getElementById('searchInput');

        let rounds = [];
        let currentRoundId = null;
        let currentScores = [];

        document.addEventListener('DOMContentLoaded', () => {
            attachEvents();
            loadRounds();
        });

        function attachEvents() {
            navToggle?.addEventListener('click', () => navMenu.classList.toggle('open'));
            navMenu.querySelectorAll('a').forEach(link => link.addEventListener('click', () => navMenu.classList.remove('open')));
            logoutBtn?.addEventListener('click', handleLogout);
            yearSelect.addEventListener('change', loadRounds);
            searchInput.addEventListener('input', renderRoundButtons);
        }

        function handleLogout() {
            sessionStorage.removeItem('hbl_authenticated');
            sessionStorage.removeItem('hbl_auth_time');
            window.location.href = 'index.html';
        }

        async function loadRounds() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/rounds`);
                if (!res.ok) throw new Error('라운드 로드 실패');
                rounds = await res.json();
            } catch (err) {
                console.warn('API 실패, fallback 사용:', err);
                rounds = getFallbackRounds();
            }
            renderRoundButtons();
        }

        function renderRoundButtons() {
            const keyword = searchInput.value.trim().toLowerCase();
            const year = yearSelect.value;
            const filtered = rounds.filter(r => r.round_date.startsWith(year) && `${r.course_name} ${r.round_name}`.toLowerCase().includes(keyword));
            roundCount.textContent = `${filtered.length}개 라운드`;

            if (filtered.length === 0) {
                roundButtons.innerHTML = '<div class="status">해당 조건의 라운드가 없습니다.</div>';
                return;
            }

            roundButtons.innerHTML = filtered.map((round, idx) => `
                <button class="round-btn ${round.id === currentRoundId || (!currentRoundId && idx === 0) ? 'active' : ''}" data-id="${round.id}">
                    ${round.course_name || '코스 미정'} · ${formatDate(round.round_date)}
                </button>
            `).join('');

            roundButtons.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => selectRound(btn.dataset.id));
            });

            const firstId = filtered[0]?.id;
            if (firstId && !currentRoundId) {
                selectRound(firstId);
            }
        }

        async function selectRound(roundId) {
            currentRoundId = roundId;
            roundButtons.querySelectorAll('button').forEach(btn => btn.classList.toggle('active', btn.dataset.id === roundId));

            try {
                const round = rounds.find(r => r.id == roundId) || {};
                roundTitle.textContent = round.round_name || '라운드 정보';
                roundMeta.textContent = `${formatDate(round.round_date)} · ${round.course_name || '코스 미정'} · 티타임 ${formatTime(round.tee_time) || '-'}`;

                const [statsRes, scoresRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/api/rounds/${roundId}/stats`).then(r => r.ok ? r.json() : {}),
                    fetch(`${API_BASE_URL}/api/rounds/${roundId}/scores`).then(r => r.ok ? r.json() : [])
                ]);

                currentScores = scoresRes || [];
                renderStats(statsRes, round);
                renderScores(currentScores);
            } catch (err) {
                console.warn('라운드 세부 로드 실패:', err);
                renderStats({}, {});
                recordsBody.innerHTML = '<tr><td colspan="5" class="status">스코어를 불러오지 못했습니다.</td></tr>';
            }
        }

        function renderStats(stats = {}, round = {}) {
            winnerMeta.textContent = stats.top_scorer || '우승자: 준비 중';
            statsSummary.innerHTML = `
                <div class="stat-card">
                    <div class="label">참가 인원</div>
                    <div class="value">${stats.participant_count ?? '-'}</div>
                </div>
                <div class="stat-card">
                    <div class="label">평균 타수</div>
                    <div class="value">${stats.avg_score ? stats.avg_score.toFixed(1) : 'N/A'}</div>
                </div>
                <div class="stat-card">
                    <div class="label">베스트 스코어</div>
                    <div class="value">${stats.best_score ?? '-'}</div>
                </div>
                <div class="stat-card">
                    <div class="label">코스</div>
                    <div class="value">${round.course_name || '-'}</div>
                </div>
            `;
        }

        function renderScores(scores = []) {
            if (!scores.length) {
                recordsBody.innerHTML = '<tr><td colspan="5" class="status">기록이 없습니다.</td></tr>';
                return;
            }

            recordsBody.innerHTML = scores.slice(0, 20).map(score => {
                const holes = score.hole_scores && score.hole_scores.length ? score.hole_scores : null;
                const holeHtml = holes ? holes.map((h, idx) => `<div class="hole-chip">${idx + 1}H · ${h || '-'}</div>`).join('') : '<div class="muted">홀별 스코어가 없습니다.</div>';
                return `
                    <tr class="clickable" onclick="toggleHoleDetails('${score.player_id || score.id || score.name}')">
                        <td><span class="rank-badge">#${score.ranking}</span></td>
                        <td>
                            <div class="row">
                                <img class="avatar" src="${score.photo_url || 'images/jay.png'}" alt="${score.name}">
                                <span>${score.name}</span>
                            </div>
                            <div class="row-toggle">클릭하여 홀별 스코어 보기</div>
                        </td>
                        <td>${score.total_score ?? '-'}</td>
                        <td>${score.birdie_count ?? 0}</td>
                        <td>${score.nearest_count ?? 0}</td>
                    </tr>
                    <tr class="details-row" id="details-${score.player_id || score.id || score.name}" style="display:none;">
                        <td colspan="5" class="details-cell">
                            <div class="hole-grid">${holeHtml}</div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function toggleHoleDetails(id) {
            const row = document.getElementById(`details-${id}`);
            if (!row) return;
            row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const d = new Date(dateString);
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const w = ['일','월','화','수','목','금','토'][d.getDay()];
            return `${y}.${m}.${day} (${w})`;
        }

        function formatTime(timeString) {
            if (!timeString) return '';
            const [h, m] = timeString.split(':');
            return `${h}:${m}`;
        }

        function getFallbackRounds() {
            return [
                { id: '1', round_name: '6월 정기 라운드', round_date: '2025-06-06', tee_time: '07:30', course_name: '스톤게이트 CC' },
                { id: '2', round_name: '5월 정기 라운드', round_date: '2025-05-11', tee_time: '07:40', course_name: '발리오스 CC' }
            ];
        }
    </script>
</body>
</html>
